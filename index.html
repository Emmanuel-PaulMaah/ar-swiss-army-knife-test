<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Combined AR + Diagnostic Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.5; }
    .status { font-weight: bold; }
    .supported { color: green; }
    .unsupported { color: red; }
    #arCanvas { width: 100%; height: 50vh; background: #000; display: none; }
    #errorMsg { color: red; margin-top: 1em; }
    button { padding: 0.5em 1em; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>AR + Diagnostics Test</h1>
  <ul id="diagResults"></ul>

  <button id="startARBtn" disabled>Start AR</button>

  <div id="arCanvas"></div>
  <div id="errorMsg"></div>

  <script>
    const diagResults = document.getElementById('diagResults');
    const startBtn = document.getElementById('startARBtn');
    const arCanvasDiv = document.getElementById('arCanvas');
    const errorMsg = document.getElementById('errorMsg');

    function addResult(label, supported, info = '') {
      const li = document.createElement('li');
      li.innerHTML = `${label}: <span class="status ${supported ? 'supported' : 'unsupported'}">${supported ? '✅ Supported' : '❌ Not Supported'}</span> ${info}`;
      diagResults.appendChild(li);
    }

    async function runDiagnostics() {
      // 1. Secure context
      addResult('Secure context (HTTPS)', window.isSecureContext);

      // 2. WebXR API
      const xrAvailable = !!navigator.xr;
      addResult('navigator.xr available', xrAvailable);

      // 3. Device type
      const ua = navigator.userAgent;
      const isAndroid = /Android/i.test(ua);
      const isIOS = /iPhone|iPad|iPod/i.test(ua);
      addResult('Device type', true, isAndroid ? 'Android' : isIOS ? 'iOS' : 'Other');

      // 4. immersive-ar support + ARCore/ARKit certification check
      let arSupport = false;
      if (xrAvailable) {
        try {
          arSupport = await navigator.xr.isSessionSupported('immersive-ar');
          addResult('immersive-ar session supported', arSupport);

          if (!arSupport) {
            addResult('ARCore/ARKit certification', false, 
              'This device does not appear to be ARCore/ARKit certified. ' +
              'Check the official list: <a href="https://developers.google.com/ar/devices" target="_blank">Google ARCore Supported Devices</a>.');
          } else {
            addResult('ARCore/ARKit certification', true, 'Device appears ARCore/ARKit ready.');
          }

        } catch (err) {
          addResult('immersive-ar session supported', false, `Error: ${err.message}`);
          addResult('ARCore/ARKit certification', false, 
            'Likely not supported. See: <a href="https://developers.google.com/ar/devices" target="_blank">Google ARCore Supported Devices</a>.');
        }
      } else {
        addResult('immersive-ar session supported', false, 'navigator.xr missing');
        addResult('ARCore/ARKit certification', false, 
          'navigator.xr missing. See: <a href="https://developers.google.com/ar/devices" target="_blank">Google ARCore Supported Devices</a>.');
      }

      // 5. Camera permission / getUserMedia
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        addResult('Camera permission / access', true);
      } catch (err) {
        addResult('Camera permission / access', false, `Error: ${err.message}`);
      }

      // 6. Motion / orientation sensors (devicemotion)
      let motionSupported = false;
      function motionListener(e) { motionSupported = true; window.removeEventListener('devicemotion', motionListener); }
      window.addEventListener('devicemotion', motionListener);
      await new Promise(res => setTimeout(res, 700));
      addResult('Device motion/orientation sensors', motionSupported);

      // 7. WebGL support
      let webgl = false;
      try {
        const canvas = document.createElement('canvas');
        webgl = !!(window.WebGLRenderingContext && (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
        addResult('WebGL support', webgl);
      } catch(e) {
        addResult('WebGL support', false);
      }

      // Enable Start AR button only if immersive-ar is supported
      if (arSupport) {
        startBtn.disabled = false;
      } else {
        errorMsg.innerText = 'AR not fully supported on this device. Start AR is disabled.';
      }
    }

    async function startAR() {
      errorMsg.innerText = '';
      try {
        const session = await navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['local-floor'] });
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl', { xrCompatible: true });
        document.body.appendChild(canvas);
        canvas.style.position = 'absolute';
        canvas.style.top = '0';
        canvas.style.left = '0';
        canvas.style.width = '100%';
        canvas.style.height = '100%';

        session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });
        const referenceSpace = await session.requestReferenceSpace('local-floor');

        const onXRFrame = (time, frame) => {
          session.requestAnimationFrame(onXRFrame);
          const pose = frame.getViewerPose(referenceSpace);
          if (pose) {
            gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer);
            gl.clearColor(0.3, 0.7, 0.3, 0.5);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
          }
        };
        session.requestAnimationFrame(onXRFrame);

      } catch (err) {
        console.error('Failed to start AR:', err);
        errorMsg.innerText = 'Failed to start AR session: ' + err.message;
      }
    }

    startBtn.addEventListener('click', startAR);
    runDiagnostics();
  </script>
</body>
</html>
