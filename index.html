<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AR Swiss Army Knife Test</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.5; }
    .status { font-weight: bold; }
    .supported { color: green; }
    .unsupported { color: red; }
    ul { list-style: none; padding: 0; }
    li { margin-bottom: 0.5em; }
    button { padding: 0.6em 1.2em; margin-top: 1em; font-size: 1em; }
    #errorMsg { color: red; margin-top: 1em; }
    canvas.xr-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  </style>
</head>
<body>
  <h1>AR Swiss Army Knife Test</h1>
  <ul id="results"></ul>

  <button id="startARBtn" disabled>Start AR</button>
  <div id="errorMsg"></div>

  <script>
    const results = document.getElementById('results');
    const startBtn = document.getElementById('startARBtn');
    const errorMsg = document.getElementById('errorMsg');

    let arSupported = false;
    let supportedFeatures = [];

    function addResult(label, supported, info = '') {
      const li = document.createElement('li');
      li.innerHTML = `${label}: <span class="status ${supported ? 'supported' : 'unsupported'}">${supported ? '✅' : '❌'}</span> ${info}`;
      results.appendChild(li);
    }

    async function runTests() {
      // 1. Secure Context
      addResult("Secure Context (HTTPS)", window.isSecureContext);

      // 2. WebXR API
      const xrAvailable = !!navigator.xr;
      addResult("navigator.xr available", xrAvailable);

      // 3. Immersive-AR Session Support
      if (xrAvailable) {
        try {
          arSupported = await navigator.xr.isSessionSupported('immersive-ar');
          addResult("Immersive-AR session support", arSupported, arSupported ? "Device reports AR capability" : "No ARCore/ARKit or unsupported browser");
        } catch (err) {
          addResult("Immersive-AR session support", false, `Error: ${err.message}`);
        }
      }

      // 4. Camera Permission
      if (navigator.mediaDevices?.getUserMedia) {
        try {
          await navigator.mediaDevices.getUserMedia({ video: true });
          addResult("Camera access", true);
        } catch (err) {
          addResult("Camera access", false, `Denied or unavailable: ${err.message}`);
        }
      } else {
        addResult("Camera access", false, "getUserMedia not available");
      }

      // 5. Motion/Orientation Sensors
      let motionSupported = false;
      function motionListener(e) { motionSupported = true; window.removeEventListener('devicemotion', motionListener); }
      window.addEventListener('devicemotion', motionListener);
      await new Promise(r => setTimeout(r, 800));
      addResult("Motion/orientation sensors", motionSupported);

      // 6. WebGL
      let webgl = false;
      try {
        const canvas = document.createElement('canvas');
        webgl = !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
      } catch(e) {}
      addResult("WebGL support", webgl);

      // 7. Session Features Test
      if (xrAvailable && arSupported) {
        const features = ['local-floor', 'bounded-floor', 'unbounded', 'hit-test', 'dom-overlay'];
        for (const feat of features) {
          try {
            await navigator.xr.requestSession('immersive-ar', { requiredFeatures: [feat] });
            addResult(`Feature "${feat}"`, true);
            supportedFeatures.push(feat);
          } catch (err) {
            addResult(`Feature "${feat}"`, false, `Not supported: ${err.message}`);
          }
        }
      }

      // 8. CORS Test
      try {
        const resp = await fetch('https://raw.githubusercontent.com/github/gitignore/main/Node.gitignore', { method: 'HEAD', mode: 'cors' });
        addResult("CORS asset fetch", resp.ok);
      } catch (err) {
        addResult("CORS asset fetch", false, `Error: ${err.message}`);
      }

      // Enable AR button if immersive-ar is supported
      if (arSupported) {
        startBtn.disabled = false;
      } else {
        errorMsg.innerText = "AR not supported on this device.";
      }
    }

    async function startAR() {
      errorMsg.innerText = '';
      try {
        const session = await navigator.xr.requestSession('immersive-ar', { optionalFeatures: supportedFeatures });
        const canvas = document.createElement('canvas');
        canvas.className = "xr-canvas";
        document.body.appendChild(canvas);
        const gl = canvas.getContext('webgl', { xrCompatible: true });

        session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });
        const refSpace = await session.requestReferenceSpace('local-floor');

        const onXRFrame = (time, frame) => {
          session.requestAnimationFrame(onXRFrame);
          const pose = frame.getViewerPose(refSpace);
          if (pose) {
            gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer);
            gl.clearColor(0.1, 0.6, 0.9, 0.4);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
          }
        };
        session.requestAnimationFrame(onXRFrame);
      } catch (err) {
        errorMsg.innerText = "Failed to start AR: " + err.message;
      }
    }

    startBtn.addEventListener('click', startAR);
    runTests();
  </script>
</body>
</html>
